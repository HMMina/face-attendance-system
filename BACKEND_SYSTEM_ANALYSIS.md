# Ph√¢n T√≠ch H·ªá Th·ªëng Backend - H·ªá Th·ªëng Ch·∫•m C√¥ng Nh·∫≠n Di·ªán Khu√¥n M·∫∑t

## üìã T·ªïng Quan D·ª± √Ån

### M·ª•c ƒê√≠ch & Ch·ª©c NƒÉng Ch√≠nh
**H·ªá Th·ªëng Ch·∫•m C√¥ng Nh·∫≠n Di·ªán Khu√¥n M·∫∑t** l√† m·ªôt gi·∫£i ph√°p c√¥ng ngh·ªá th√¥ng minh ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·ªÉ:

- **T·ª± ƒë·ªông h√≥a quy tr√¨nh ch·∫•m c√¥ng**: Thay th·∫ø c√°c ph∆∞∆°ng ph√°p ch·∫•m c√¥ng truy·ªÅn th·ªëng (th·∫ª t·ª´, v√¢n tay) b·∫±ng c√¥ng ngh·ªá nh·∫≠n di·ªán khu√¥n m·∫∑t
- **Qu·∫£n l√Ω ƒëa thi·∫øt b·ªã**: H·ªó tr·ª£ nhi·ªÅu m√°y ch·∫•m c√¥ng (kiosk) ho·∫°t ƒë·ªông ƒë·ªìng th·ªùi trong c√πng h·ªá th·ªëng m·∫°ng
- **Theo d√µi th·ªùi gian th·ª±c**: Gi√°m s√°t vi·ªác ch·∫•m c√¥ng, t√¨nh tr·∫°ng thi·∫øt b·ªã v√† k·∫øt n·ªëi li√™n t·ª•c
- **Qu·∫£n l√Ω nh√¢n vi√™n t·∫≠p trung**: B·∫£ng ƒëi·ªÅu khi·ªÉn qu·∫£n tr·ªã ƒë·ªÉ qu·∫£n l√Ω nh√¢n vi√™n, thi·∫øt b·ªã v√† b√°o c√°o

> **Gi·∫£i th√≠ch thu·∫≠t ng·ªØ:**
> - **Kiosk**: M√°y t√≠nh ƒë·∫∑t t·∫°i c√°c v·ªã tr√≠ c·ªë ƒë·ªãnh (c·ª≠a ra v√†o) ƒë·ªÉ nh√¢n vi√™n th·ª±c hi·ªán ch·∫•m c√¥ng
> - **Real-time**: Th·ªùi gian th·ª±c - x·ª≠ l√Ω v√† c·∫≠p nh·∫≠t d·ªØ li·ªáu ngay l·∫≠p t·ª©c
> - **Dashboard**: B·∫£ng ƒëi·ªÅu khi·ªÉn - giao di·ªán t·ªïng quan ƒë·ªÉ qu·∫£n l√Ω v√† theo d√µi h·ªá th·ªëng

### V·∫•n ƒê·ªÅ D·ª± √Ån Gi·∫£i Quy·∫øt
1. **NgƒÉn ch·∫∑n gian l·∫≠n ch·∫•m c√¥ng**: Tr√°nh t√¨nh tr·∫°ng "ch·∫•m c√¥ng h·ªô" nh·ªù v√†o c√¥ng ngh·ªá nh·∫≠n di·ªán khu√¥n m·∫∑t ch√≠nh x√°c
2. **ƒê∆°n gi·∫£n h√≥a qu·∫£n l√Ω**: T·∫≠p trung h√≥a vi·ªác qu·∫£n l√Ω ch·∫•m c√¥ng t·ª´ nhi·ªÅu ƒë·ªãa ƒëi·ªÉm kh√°c nhau
3. **T√≠ch h·ª£p d·ªÖ d√†ng**: T·ª± ƒë·ªông ph√°t hi·ªán v√† k·∫øt n·ªëi c√°c m√°y ch·∫•m c√¥ng th√¥ng qua c√¥ng ngh·ªá mDNS
4. **N√¢ng cao ƒë·ªô ch√≠nh x√°c**: S·ª≠ d·ª•ng tr√≠ tu·ªá nh√¢n t·∫°o v√† h·ªá th·ªëng m·∫´u h·ªçc li√™n t·ª•c ƒë·ªÉ c·∫£i thi·ªán ƒë·ªô ch√≠nh x√°c theo th·ªùi gian

> **Gi·∫£i th√≠ch thu·∫≠t ng·ªØ:**
> - **mDNS**: Multicast DNS - c√¥ng ngh·ªá gi√∫p c√°c thi·∫øt b·ªã t·ª± ƒë·ªông t√¨m th·∫•y nhau trong m·∫°ng n·ªôi b·ªô
> - **Template System**: H·ªá th·ªëng m·∫´u - l∆∞u tr·ªØ v√† c·∫≠p nh·∫≠t c√°c ƒë·∫∑c tr∆∞ng khu√¥n m·∫∑t ƒë·ªÉ c·∫£i thi·ªán nh·∫≠n di·ªán
> - **AI**: Artificial Intelligence - Tr√≠ tu·ªá nh√¢n t·∫°o

---

## üõ†Ô∏è C√¥ng Ngh·ªá & C√¥ng C·ª• S·ª≠ D·ª•ng

### Ng√¥n Ng·ªØ L·∫≠p Tr√¨nh
- **Python 3.10+**: Ng√¥n ng·ªØ ch√≠nh cho backend (ph·∫ßn m√°y ch·ªß)
- **JavaScript**: Ng√¥n ng·ªØ cho giao di·ªán qu·∫£n tr·ªã web
- **Dart/Flutter**: Ng√¥n ng·ªØ cho ·ª©ng d·ª•ng m√°y ch·∫•m c√¥ng

> **Gi·∫£i th√≠ch thu·∫≠t ng·ªØ:**
> - **Backend**: Ph·∫ßn h·ªá th·ªëng ch·∫°y tr√™n m√°y ch·ªß, x·ª≠ l√Ω logic nghi·ªáp v·ª• v√† d·ªØ li·ªáu
> - **Frontend**: Ph·∫ßn giao di·ªán ng∆∞·ªùi d√πng, hi·ªÉn th·ªã tr√™n m√†n h√¨nh v√† t∆∞∆°ng t√°c tr·ª±c ti·∫øp

### Framework & Th∆∞ Vi·ªán Ch√≠nh

#### Framework Backend (Khung Ph√°t Tri·ªÉn M√°y Ch·ªß)
- **FastAPI 0.104.1**: Framework web hi·ªán ƒë·∫°i v·ªõi kh·∫£ nƒÉng x·ª≠ l√Ω b·∫•t ƒë·ªìng b·ªô cao
- **Uvicorn**: M√°y ch·ªß ASGI hi·ªáu su·∫•t cao ƒë·ªÉ ch·∫°y ·ª©ng d·ª•ng web
- **SQLAlchemy 2.0.23**: C√¥ng c·ª• ORM ƒë·ªÉ thao t√°c v·ªõi c∆° s·ªü d·ªØ li·ªáu b·∫±ng Python
- **Alembic 1.12.1**: C√¥ng c·ª• qu·∫£n l√Ω phi√™n b·∫£n v√† migration c∆° s·ªü d·ªØ li·ªáu
- **Pydantic 2.5.0**: Th∆∞ vi·ªán x√°c th·ª±c v√† chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu ƒë·∫ßu v√†o/ƒë·∫ßu ra

> **Gi·∫£i th√≠ch thu·∫≠t ng·ªØ:**
> - **Framework**: Khung ph√°t tri·ªÉn - b·ªô c√¥ng c·ª• v√† th∆∞ vi·ªán c√≥ s·∫µn gi√∫p ph√°t tri·ªÉn ·ª©ng d·ª•ng nhanh h∆°n
> - **ASGI**: Asynchronous Server Gateway Interface - giao th·ª©c cho m√°y ch·ªß web b·∫•t ƒë·ªìng b·ªô
> - **ORM**: Object-Relational Mapping - c√¥ng ngh·ªá √°nh x·∫° d·ªØ li·ªáu t·ª´ c∆° s·ªü d·ªØ li·ªáu th√†nh ƒë·ªëi t∆∞·ª£ng Python
> - **Migration**: Qu√° tr√¨nh c·∫≠p nh·∫≠t c·∫•u tr√∫c c∆° s·ªü d·ªØ li·ªáu m·ªôt c√°ch c√≥ ki·ªÉm so√°t

#### Th∆∞ Vi·ªán AI/ML (Tr√≠ Tu·ªá Nh√¢n T·∫°o / H·ªçc M√°y)
```python
# X·ª≠ l√Ω h√¨nh ·∫£nh & nh·∫≠n di·ªán khu√¥n m·∫∑t
opencv-python==4.8.1.78           # Th∆∞ vi·ªán x·ª≠ l√Ω h√¨nh ·∫£nh m√°y t√≠nh
face-recognition==1.3.0            # Th∆∞ vi·ªán nh·∫≠n di·ªán v√† m√£ h√≥a khu√¥n m·∫∑t
insightface==0.7.3                 # Th∆∞ vi·ªán nh·∫≠n di·ªán khu√¥n m·∫∑t n√¢ng cao
dlib==19.24.2                      # B·ªô c√¥ng c·ª• h·ªçc m√°y

# H·ªçc s√¢u (Deep Learning)
torch==2.1.1, torchvision==0.16.1  # Framework PyTorch cho h·ªçc s√¢u
ultralytics==8.0.196               # YOLOv11 ƒë·ªÉ ph√°t hi·ªán ƒë·ªëi t∆∞·ª£ng
onnxruntime==1.16.3                # C√¥ng c·ª• ch·∫°y m√¥ h√¨nh ONNX

# T√≠nh to√°n khoa h·ªçc
numpy==1.24.3, scipy==1.11.4       # Th∆∞ vi·ªán t√≠nh to√°n s·ªë h·ªçc
scikit-learn==1.3.0                # Thu·∫≠t to√°n h·ªçc m√°y
```

> **Gi·∫£i th√≠ch thu·∫≠t ng·ªØ:**
> - **Computer Vision**: Th·ªã gi√°c m√°y t√≠nh - kh·∫£ nƒÉng m√°y t√≠nh "nh√¨n" v√† hi·ªÉu h√¨nh ·∫£nh
> - **Deep Learning**: H·ªçc s√¢u - lo·∫°i AI s·ª≠ d·ª•ng m·∫°ng n∆°-ron nhi·ªÅu l·ªõp
> - **YOLO**: You Only Look Once - thu·∫≠t to√°n ph√°t hi·ªán ƒë·ªëi t∆∞·ª£ng trong th·ªùi gian th·ª±c
> - **ONNX**: Open Neural Network Exchange - ƒë·ªãnh d·∫°ng m·ªü ƒë·ªÉ trao ƒë·ªïi m√¥ h√¨nh AI
> - **Neural Network**: M·∫°ng n∆°-ron - m√¥ h√¨nh to√°n h·ªçc m√¥ ph·ªèng c√°ch ho·∫°t ƒë·ªông c·ªßa n√£o b·ªô

#### B·∫£o M·∫≠t & X√°c Th·ª±c
- **python-jose[cryptography]**: Qu·∫£n l√Ω token JWT ƒë·ªÉ x√°c th·ª±c ng∆∞·ªùi d√πng
- **passlib[bcrypt]**: M√£ h√≥a m·∫≠t kh·∫©u an to√†n
- **python-multipart**: X·ª≠ l√Ω t·∫£i l√™n file ƒëa ph·∫ßn

> **Gi·∫£i th√≠ch thu·∫≠t ng·ªØ:**
> - **JWT**: JSON Web Token - chu·∫©n m·ªü ƒë·ªÉ truy·ªÅn th√¥ng tin an to√†n gi·ªØa c√°c b√™n
> - **Hashing**: BƒÉm - qu√° tr√¨nh bi·∫øn ƒë·ªïi d·ªØ li·ªáu th√†nh chu·ªói k√Ω t·ª± c·ªë ƒë·ªãnh, kh√¥ng th·ªÉ ƒë·∫£o ng∆∞·ª£c
> - **Bcrypt**: Thu·∫≠t to√°n bƒÉm m·∫≠t kh·∫©u v·ªõi ƒë·ªô b·∫£o m·∫≠t cao

### C∆° S·ªü D·ªØ Li·ªáu & T·ªï Ch·ª©c D·ªØ Li·ªáu

#### Engine C∆° S·ªü D·ªØ Li·ªáu
- **PostgreSQL**: H·ªá qu·∫£n tr·ªã c∆° s·ªü d·ªØ li·ªáu quan h·ªá ch√≠nh v·ªõi k·∫øt n·ªëi psycopg2-binary
- **SQLAlchemy ORM**: √Ånh x·∫° quan h·ªá ƒë·ªëi t∆∞·ª£ng v·ªõi h·ªó tr·ª£ b·∫•t ƒë·ªìng b·ªô

> **Gi·∫£i th√≠ch thu·∫≠t ng·ªØ:**
> - **PostgreSQL**: H·ªá qu·∫£n tr·ªã c∆° s·ªü d·ªØ li·ªáu m√£ ngu·ªìn m·ªü, m·∫°nh m·∫Ω v√† ·ªïn ƒë·ªãnh
> - **Relational Database**: C∆° s·ªü d·ªØ li·ªáu quan h·ªá - t·ªï ch·ª©c d·ªØ li·ªáu d∆∞·ªõi d·∫°ng b·∫£ng c√≥ li√™n k·∫øt
> - **Async**: B·∫•t ƒë·ªìng b·ªô - kh·∫£ nƒÉng x·ª≠ l√Ω nhi·ªÅu t√°c v·ª• c√πng l√∫c m√† kh√¥ng ch·ªù ƒë·ª£i

#### C·∫•u Tr√∫c M√¥ H√¨nh D·ªØ Li·ªáu
```python
# C√°c m√¥ h√¨nh d·ªØ li·ªáu ch√≠nh
‚îú‚îÄ‚îÄ Employee          # Nh√¢n vi√™n (m√£ NV, h·ªç t√™n, ph√≤ng ban, ...)
‚îú‚îÄ‚îÄ Device           # Thi·∫øt b·ªã kiosk (m√£ thi·∫øt b·ªã, t√™n, ƒë·ªãa ch·ªâ IP, tr·∫°ng th√°i)
‚îú‚îÄ‚îÄ Attendance       # L·ªãch s·ª≠ ch·∫•m c√¥ng (m√£ NV, m√£ thi·∫øt b·ªã, th·ªùi gian, lo·∫°i h√†nh ƒë·ªông)
‚îú‚îÄ‚îÄ FaceTemplate     # M·∫´u nh·∫≠n di·ªán (m√£ NV, d·ªØ li·ªáu ƒë·∫∑c tr∆∞ng, ƒëi·ªÉm ch·∫•t l∆∞·ª£ng)
‚îî‚îÄ‚îÄ NetworkLog       # Nh·∫≠t k√Ω ho·∫°t ƒë·ªông m·∫°ng v√† thi·∫øt b·ªã
```

#### M·ªëi Quan H·ªá D·ªØ Li·ªáu
- **Employee 1:N Attendance**: M·ªôt nh√¢n vi√™n c√≥ nhi·ªÅu b·∫£n ghi ch·∫•m c√¥ng
- **Employee 1:N FaceTemplate**: M·ªôt nh√¢n vi√™n c√≥ nhi·ªÅu m·∫´u khu√¥n m·∫∑t (h·ªá th·ªëng h·ªçc li√™n t·ª•c)
- **Device 1:N Attendance**: M·ªôt thi·∫øt b·ªã x·ª≠ l√Ω nhi·ªÅu l·∫ßn ch·∫•m c√¥ng
- **Device 1:N NetworkLog**: Theo d√µi ho·∫°t ƒë·ªông c·ªßa thi·∫øt b·ªã

> **Gi·∫£i th√≠ch thu·∫≠t ng·ªØ:**
> - **1:N**: Quan h·ªá m·ªôt-nhi·ªÅu - m·ªôt b·∫£n ghi ·ªü b·∫£ng n√†y li√™n k·∫øt v·ªõi nhi·ªÅu b·∫£n ghi ·ªü b·∫£ng kh√°c
> - **Template**: M·∫´u - d·ªØ li·ªáu ƒë·∫∑c tr∆∞ng c·ªßa khu√¥n m·∫∑t ƒë∆∞·ª£c l∆∞u tr·ªØ ƒë·ªÉ so s√°nh
> - **Log**: Nh·∫≠t k√Ω - ghi l·∫°i c√°c s·ª± ki·ªán v√† ho·∫°t ƒë·ªông c·ªßa h·ªá th·ªëng

### C√¥ng Ngh·ªá H·∫° T·∫ßng

#### Kh√°m Ph√° D·ªãch V·ª• (Service Discovery)
- **mDNS/Bonjour**: T·ª± ƒë·ªông ph√°t hi·ªán m√°y ch·ªß trong m·∫°ng n·ªôi b·ªô
- **T√™n d·ªãch v·ª•**: `_attendance._tcp.local.`
- **M·∫°ng kh√¥ng c·∫•u h√¨nh**: C√°c thi·∫øt b·ªã kiosk t·ª± ƒë·ªông k·∫øt n·ªëi v·ªõi m√°y ch·ªß

> **Gi·∫£i th√≠ch thu·∫≠t ng·ªØ:**
> - **Service Discovery**: Kh√°m ph√° d·ªãch v·ª• - c∆° ch·∫ø t·ª± ƒë·ªông t√¨m v√† k·∫øt n·ªëi c√°c d·ªãch v·ª• trong m·∫°ng
> - **Bonjour**: C√¥ng ngh·ªá c·ªßa Apple cho vi·ªác kh√°m ph√° d·ªãch v·ª• t·ª± ƒë·ªông
> - **Zero-config**: Kh√¥ng c·∫ßn c·∫•u h√¨nh - t·ª± ƒë·ªông thi·∫øt l·∫≠p k·∫øt n·ªëi

#### Ki·∫øn Tr√∫c API
- **RESTful APIs**: API tu√¢n theo chu·∫©n REST v·ªõi c√°c ph∆∞∆°ng th·ª©c HTTP ti√™u chu·∫©n
- **X·ª≠ l√Ω b·∫•t ƒë·ªìng b·ªô**: FastAPI async/await cho kh·∫£ nƒÉng x·ª≠ l√Ω ƒë·ªìng th·ªùi cao
- **Giao ti·∫øp th·ªùi gian th·ª±c**: C∆° ch·∫ø heartbeat ƒë·ªÉ gi√°m s√°t thi·∫øt b·ªã

> **Gi·∫£i th√≠ch thu·∫≠t ng·ªØ:**
> - **REST**: Representational State Transfer - ki·ªÉu ki·∫øn tr√∫c ph·∫ßn m·ªÅm cho d·ªãch v·ª• web
> - **API**: Application Programming Interface - giao di·ªán l·∫≠p tr√¨nh ·ª©ng d·ª•ng
> - **HTTP**: Hypertext Transfer Protocol - giao th·ª©c truy·ªÅn t·∫£i si√™u vƒÉn b·∫£n
> - **Heartbeat**: T√≠n hi·ªáu "nh·ªãp tim" - t√≠n hi·ªáu ƒë·ªãnh k·ª≥ ƒë·ªÉ x√°c nh·∫≠n thi·∫øt b·ªã v·∫´n ho·∫°t ƒë·ªông

#### Container & Tri·ªÉn Khai
```dockerfile
# H·ªó tr·ª£ Docker
‚îú‚îÄ‚îÄ Dockerfile                    # ƒê√≥ng g√≥i backend th√†nh container
‚îú‚îÄ‚îÄ docker-compose.local.yml      # C·∫•u h√¨nh ph√°t tri·ªÉn local
‚îú‚îÄ‚îÄ docker-compose.prod.yml       # C·∫•u h√¨nh tri·ªÉn khai production
‚îî‚îÄ‚îÄ nginx/                        # C·∫•u h√¨nh reverse proxy
```

> **Gi·∫£i th√≠ch thu·∫≠t ng·ªØ:**
> - **Docker**: C√¥ng ngh·ªá container h√≥a ·ª©ng d·ª•ng
> - **Container**: G√≥i ph·∫ßn m·ªÅm bao g·ªìm ·ª©ng d·ª•ng v√† t·∫•t c·∫£ ph·ª• thu·ªôc
> - **Reverse Proxy**: M√°y ch·ªß trung gian chuy·ªÉn ti·∫øp y√™u c·∫ßu t·ª´ client ƒë·∫øn server th·ª±c

---

## üèóÔ∏è Ki·∫øn Tr√∫c & C·∫•u Tr√∫c D·ª± √Ån

### M√¥ H√¨nh Ki·∫øn Tr√∫c
**Ki·∫øn Tr√∫c ƒêa T·∫ßng Client-Server v·ªõi C√°c Th√†nh Ph·∫ßn Microservices**:

> **Gi·∫£i th√≠ch thu·∫≠t ng·ªØ:**
> - **Multi-Tier**: ƒêa t·∫ßng - chia h·ªá th·ªëng th√†nh c√°c t·∫ßng logic ri√™ng bi·ªát
> - **Client-Server**: M√¥ h√¨nh m√°y kh√°ch-m√°y ch·ªß - clients g·ª≠i y√™u c·∫ßu, server x·ª≠ l√Ω v√† ph·∫£n h·ªìi
> - **Microservices**: Ki·∫øn tr√∫c vi d·ªãch v·ª• - chia ·ª©ng d·ª•ng th√†nh c√°c d·ªãch v·ª• nh·ªè ƒë·ªôc l·∫≠p

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  ·ª®ng D·ª•ng Kiosk ‚îÇ    ‚îÇ B·∫£ng ƒêi·ªÅu Khi·ªÉn‚îÇ    ‚îÇ  ·ª®ng D·ª•ng Di    ‚îÇ
‚îÇ   (Flutter)     ‚îÇ    ‚îÇ Qu·∫£n Tr·ªã (React)‚îÇ    ‚îÇ  ƒê·ªông (T∆∞∆°ng lai)‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
         ‚îÇ                       ‚îÇ                       ‚îÇ
         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                 ‚îÇ
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ         Backend FastAPI             ‚îÇ
              ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
              ‚îÇ  ‚îÇ      T·∫ßng D·ªãch V·ª•              ‚îÇ‚îÇ
              ‚îÇ  ‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ‚îÇ
              ‚îÇ  ‚îÇ ‚îÇD·ªãch V·ª•  ‚îÇ ‚îÇQu·∫£n L√Ω Thi·∫øt B·ªã ‚îÇ ‚îÇ‚îÇ
              ‚îÇ  ‚îÇ ‚îÇAI/ML    ‚îÇ ‚îÇ& Kh√°m Ph√°       ‚îÇ ‚îÇ‚îÇ
              ‚îÇ  ‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ‚îÇ
              ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
              ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê‚îÇ
              ‚îÇ  ‚îÇ         T·∫ßng API                ‚îÇ‚îÇ
              ‚îÇ  ‚îÇ /employees /devices /attendance ‚îÇ‚îÇ
              ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                 ‚îÇ
              ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
              ‚îÇ      C∆° S·ªü D·ªØ Li·ªáu PostgreSQL      ‚îÇ
              ‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
              ‚îÇ ‚îÇnh√¢n vi√™n‚îÇ ‚îÇthi·∫øt b·ªã ‚îÇ ‚îÇch·∫•m c√¥ng‚îÇ ‚îÇ
              ‚îÇ ‚îÇm·∫´u nh·∫≠n ‚îÇ ‚îÇnh·∫≠t k√Ω  ‚îÇ ‚îÇ...      ‚îÇ ‚îÇ
              ‚îÇ ‚îÇdi·ªán     ‚îÇ ‚îÇ         ‚îÇ ‚îÇ         ‚îÇ ‚îÇ
              ‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
              ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### C√°ch T·ªï Ch·ª©c Th∆∞ M·ª•c & File Code

```
backend/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ main.py                 # ƒêi·ªÉm kh·ªüi ƒë·ªông FastAPI & c·∫•u h√¨nh ·ª©ng d·ª•ng
‚îÇ   ‚îú‚îÄ‚îÄ config/                 # Qu·∫£n l√Ω c·∫•u h√¨nh
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ database.py         # C·∫•u h√¨nh k·∫øt n·ªëi c∆° s·ªü d·ªØ li·ªáu
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ multi_kiosk_config_fixed.py  # C·∫•u h√¨nh ƒëa kiosk
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ settings.py         # C√†i ƒë·∫∑t ·ª©ng d·ª•ng
‚îÇ   ‚îú‚îÄ‚îÄ models/                 # M√¥ h√¨nh d·ªØ li·ªáu SQLAlchemy ORM
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ base.py            # L·ªõp m√¥ h√¨nh c∆° s·ªü
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ employee.py        # M√¥ h√¨nh d·ªØ li·ªáu nh√¢n vi√™n
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ device.py          # M√¥ h√¨nh qu·∫£n l√Ω thi·∫øt b·ªã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ attendance.py      # M√¥ h√¨nh b·∫£n ghi ch·∫•m c√¥ng
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ face_template.py   # M√¥ h√¨nh l∆∞u tr·ªØ m·∫´u khu√¥n m·∫∑t
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ network_log.py     # Nh·∫≠t k√Ω ho·∫°t ƒë·ªông m·∫°ng
‚îÇ   ‚îú‚îÄ‚îÄ schemas/               # Schemas x√°c th·ª±c d·ªØ li·ªáu Pydantic
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ employee.py        # Schemas y√™u c·∫ßu/ph·∫£n h·ªìi nh√¢n vi√™n
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ device.py          # Schemas API thi·∫øt b·ªã
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ attendance.py      # Schemas d·ªØ li·ªáu ch·∫•m c√¥ng
‚îÇ   ‚îú‚îÄ‚îÄ api/                   # T·ªï ch·ª©c c√°c endpoint API
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ v1/                # Phi√™n b·∫£n API 1
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ employees.py   # Endpoints qu·∫£n l√Ω nh√¢n vi√™n
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ devices.py     # ƒêƒÉng k√Ω & qu·∫£n l√Ω thi·∫øt b·ªã
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ attendance.py  # Endpoints x·ª≠ l√Ω ch·∫•m c√¥ng
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.py        # Endpoints x√°c th·ª±c
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ recognition.py # Endpoints nh·∫≠n di·ªán khu√¥n m·∫∑t
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ discovery.py   # Endpoints kh√°m ph√° d·ªãch v·ª•
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ monitoring.py  # Endpoints gi√°m s√°t h·ªá th·ªëng
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ templates.py       # API qu·∫£n l√Ω m·∫´u
‚îÇ   ‚îú‚îÄ‚îÄ services/              # D·ªãch v·ª• logic nghi·ªáp v·ª•
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ enhanced_recognition_service.py     # Engine nh·∫≠n di·ªán ch√≠nh
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ enhanced_face_embedding_service.py  # Nh√∫ng khu√¥n m·∫∑t & m·∫´u
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ real_ai_service.py                  # T√≠ch h·ª£p m√¥ h√¨nh AI
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ template_manager_service.py         # Qu·∫£n l√Ω v√≤ng ƒë·ªùi m·∫´u
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ device_manager.py                   # V√≤ng ƒë·ªùi thi·∫øt b·ªã & heartbeat
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ device_service.py                   # Thao t√°c thi·∫øt b·ªã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ discovery_service.py                # Kh√°m ph√° d·ªãch v·ª• mDNS
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ employee_service.py                 # Thao t√°c nh√¢n vi√™n
‚îÇ   ‚îú‚îÄ‚îÄ core/                  # Ti·ªán √≠ch c·ªët l√µi
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ security.py        # X√°c th·ª±c & ph√¢n quy·ªÅn
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ dependencies.py    # Ph·ª• thu·ªôc FastAPI
‚îÇ   ‚îî‚îÄ‚îÄ utils/                 # Ti·ªán √≠ch h·ªó tr·ª£
‚îÇ       ‚îú‚îÄ‚îÄ image_processing.py # Ti·ªán √≠ch x·ª≠ l√Ω h√¨nh ·∫£nh
‚îÇ       ‚îî‚îÄ‚îÄ logging.py         # C·∫•u h√¨nh ghi nh·∫≠t k√Ω
‚îú‚îÄ‚îÄ data/                      # L∆∞u tr·ªØ d·ªØ li·ªáu
‚îÇ   ‚îú‚îÄ‚îÄ uploads/               # H√¨nh ·∫£nh ƒë∆∞·ª£c t·∫£i l√™n
‚îÇ   ‚îú‚îÄ‚îÄ models/                # File m√¥ h√¨nh AI
‚îÇ   ‚îî‚îÄ‚îÄ employee_photos/       # ·∫¢nh tham kh·∫£o nh√¢n vi√™n
‚îú‚îÄ‚îÄ alembic/                   # Migration c∆° s·ªü d·ªØ li·ªáu
‚îú‚îÄ‚îÄ requirements.txt           # Ph·ª• thu·ªôc Python
‚îú‚îÄ‚îÄ requirements_ai.txt        # Ph·ª• thu·ªôc AI c·ª• th·ªÉ
‚îî‚îÄ‚îÄ Dockerfile                 # C·∫•u h√¨nh container
```

> **Gi·∫£i th√≠ch thu·∫≠t ng·ªØ:**
> - **Schema**: C·∫•u tr√∫c d·ªØ li·ªáu - ƒë·ªãnh nghƒ©a format v√† quy t·∫Øc c·ªßa d·ªØ li·ªáu ƒë·∫ßu v√†o/ra
> - **Endpoint**: ƒêi·ªÉm cu·ªëi - URL c·ª• th·ªÉ m√† client c√≥ th·ªÉ g·ªçi ƒë·ªÉ truy c·∫≠p ch·ª©c nƒÉng
> - **Engine**: ƒê·ªông c∆° - th√†nh ph·∫ßn ch√≠nh th·ª±c hi·ªán m·ªôt ch·ª©c nƒÉng c·ª• th·ªÉ
> - **Embedding**: Nh√∫ng - bi·ªÉu di·ªÖn d·ªØ li·ªáu (nh∆∞ khu√¥n m·∫∑t) d∆∞·ªõi d·∫°ng vector s·ªë
> - **Migration**: Di c∆∞ - qu√° tr√¨nh c·∫≠p nh·∫≠t c·∫•u tr√∫c c∆° s·ªü d·ªØ li·ªáu c√≥ ki·ªÉm so√°t

### Vai Tr√≤ T·ª´ng Module Ch√≠nh

#### 1. **T·∫ßng API (`app/api/`)**
- **Tr√°ch nhi·ªám**: X·ª≠ l√Ω y√™u c·∫ßu HTTP, x√°c th·ª±c ƒë·∫ßu v√†o, ƒë·ªãnh d·∫°ng ph·∫£n h·ªìi
- **T√≠nh nƒÉng ch√≠nh**: Endpoints RESTful, x·ª≠ l√Ω y√™u c·∫ßu b·∫•t ƒë·ªìng b·ªô, x·ª≠ l√Ω l·ªói
- **Modules ch√≠nh**:
  - `employees.py`: Thao t√°c CRUD cho qu·∫£n l√Ω nh√¢n vi√™n
  - `devices.py`: ƒêƒÉng k√Ω thi·∫øt b·ªã, heartbeat, qu·∫£n l√Ω tr·∫°ng th√°i
  - `attendance.py`: X·ª≠ l√Ω ch·∫•m c√¥ng & truy xu·∫•t l·ªãch s·ª≠
  - `recognition.py`: Endpoints API nh·∫≠n di·ªán khu√¥n m·∫∑t

> **Gi·∫£i th√≠ch thu·∫≠t ng·ªØ:**
> - **CRUD**: Create, Read, Update, Delete - b·ªën thao t√°c c∆° b·∫£n v·ªõi d·ªØ li·ªáu
> - **HTTP**: Giao th·ª©c truy·ªÅn t·∫£i si√™u vƒÉn b·∫£n ƒë·ªÉ giao ti·∫øp web

#### 2. **T·∫ßng D·ªãch V·ª• (`app/services/`)**
- **Tr√°ch nhi·ªám**: Logic nghi·ªáp v·ª•, x·ª≠ l√Ω AI, ƒëi·ªÅu ph·ªëi thi·∫øt b·ªã
- **T√≠nh nƒÉng ch√≠nh**: Nh·∫≠n di·ªán khu√¥n m·∫∑t, qu·∫£n l√Ω m·∫´u, ƒëi·ªÅu ph·ªëi thi·∫øt b·ªã
- **Modules ch√≠nh**:
  - `enhanced_recognition_service.py`: Engine nh·∫≠n di·ªán c·ªët l√µi
  - `device_manager.py`: ƒêi·ªÅu ph·ªëi ƒëa thi·∫øt b·ªã & gi√°m s√°t
  - `template_manager_service.py`: H·ªá th·ªëng m·∫´u h·ªçc li√™n t·ª•c
  - `discovery_service.py`: Kh√°m ph√° d·ªãch v·ª• m·∫°ng

#### 3. **T·∫ßng D·ªØ Li·ªáu (`app/models/` & `app/schemas/`)**
- **Tr√°ch nhi·ªám**: L∆∞u tr·ªØ d·ªØ li·ªáu, x√°c th·ª±c, tu·∫ßn t·ª± h√≥a
- **T√≠nh nƒÉng ch√≠nh**: M√¥ h√¨nh ORM, x√°c th·ª±c y√™u c·∫ßu/ph·∫£n h·ªìi, thao t√°c c∆° s·ªü d·ªØ li·ªáu
- **Modules ch√≠nh**:
  - Models: ƒê·ªãnh nghƒ©a th·ª±c th·ªÉ c∆° s·ªü d·ªØ li·ªáu
  - Schemas: X√°c th·ª±c y√™u c·∫ßu/ph·∫£n h·ªìi API

#### 4. **H·∫° T·∫ßng C·ªët L√µi (`app/core/` & `app/config/`)**
- **Tr√°ch nhi·ªám**: C·∫•u h√¨nh ·ª©ng d·ª•ng, b·∫£o m·∫≠t, ti·ªán √≠ch d√πng chung
- **T√≠nh nƒÉng ch√≠nh**: K·∫øt n·ªëi c∆° s·ªü d·ªØ li·ªáu, x√°c th·ª±c, ghi nh·∫≠t k√Ω, qu·∫£n l√Ω c√†i ƒë·∫∑t

> **Gi·∫£i th√≠ch thu·∫≠t ng·ªØ:**
> - **Business Logic**: Logic nghi·ªáp v·ª• - quy t·∫Øc v√† quy tr√¨nh x·ª≠ l√Ω theo y√™u c·∫ßu kinh doanh
> - **Orchestration**: ƒêi·ªÅu ph·ªëi - qu·∫£n l√Ω v√† ph·ªëi h·ª£p nhi·ªÅu th√†nh ph·∫ßn ho·∫°t ƒë·ªông c√πng nhau
> - **Serialization**: Tu·∫ßn t·ª± h√≥a - chuy·ªÉn ƒë·ªïi ƒë·ªëi t∆∞·ª£ng th√†nh format c√≥ th·ªÉ truy·ªÅn t·∫£i (JSON)

---

## üß† Thu·∫≠t To√°n & Logic X·ª≠ L√Ω

### C√°c Thu·∫≠t To√°n Ch√≠nh

#### 1. **Quy Tr√¨nh Nh·∫≠n Di·ªán Khu√¥n M·∫∑t (Face Recognition Pipeline)**
```python
# Quy tr√¨nh nh·∫≠n di·ªán ƒëa giai ƒëo·∫°n
def recognize_face(image_bytes: bytes) -> Dict:
    # Giai ƒëo·∫°n 1: Ph√°t hi·ªán khu√¥n m·∫∑t
    faces = face_detector.detect_faces(image)
    
    # Giai ƒëo·∫°n 2: ƒê√°nh gi√° ch·∫•t l∆∞·ª£ng khu√¥n m·∫∑t
    quality_score = assess_face_quality(face_roi)
    
    # Giai ƒëo·∫°n 3: Tr√≠ch xu·∫•t ƒë·∫∑c tr∆∞ng
    face_encoding = extract_face_encoding(face_roi)
    
    # Giai ƒëo·∫°n 4: So kh·ªõp v·ªõi m·∫´u
    best_match = compare_with_templates(face_encoding)
    
    # Giai ƒëo·∫°n 5: Ki·ªÉm tra ng∆∞·ª°ng tin c·∫≠y
    if similarity > RECOGNITION_THRESHOLD:
        return recognition_result
```

> **Gi·∫£i th√≠ch thu·∫≠t ng·ªØ:**
> - **Face Detection**: Ph√°t hi·ªán khu√¥n m·∫∑t - t√¨m v·ªã tr√≠ khu√¥n m·∫∑t trong ·∫£nh
> - **ROI**: Region of Interest - v√πng quan t√¢m, l√† ph·∫ßn ·∫£nh ch·ª©a khu√¥n m·∫∑t
> - **Feature Extraction**: Tr√≠ch xu·∫•t ƒë·∫∑c tr∆∞ng - chuy·ªÉn ƒë·ªïi khu√¥n m·∫∑t th√†nh vector s·ªë
> - **Encoding**: M√£ h√≥a - bi·ªÉu di·ªÖn khu√¥n m·∫∑t d∆∞·ªõi d·∫°ng d√£y s·ªë ƒë·∫∑c tr∆∞ng
> - **Threshold**: Ng∆∞·ª°ng - gi√° tr·ªã chu·∫©n ƒë·ªÉ quy·∫øt ƒë·ªãnh c√≥ ch·∫•p nh·∫≠n k·∫øt qu·∫£ hay kh√¥ng

**Ph√¢n c·∫•p Ng∆∞·ª°ng Tin C·∫≠y**:
- `RECOGNITION_THRESHOLD = 0.65`: Ng∆∞·ª°ng t·ªëi thi·ªÉu ƒë·ªÉ nh·∫≠n di·ªán th√†nh c√¥ng
- `HIGH_CONFIDENCE_THRESHOLD = 0.75`: Ng∆∞·ª°ng tin c·∫≠y cao
- `VERY_HIGH_CONFIDENCE_THRESHOLD = 0.85`: Ng∆∞·ª°ng tin c·∫≠y r·∫•t cao

#### 2. **H·ªá Th·ªëng M·∫´u H·ªçc Li√™n T·ª•c (Rolling Template System)**
```python
# C∆° ch·∫ø h·ªçc ƒë·ªÉ c·∫£i thi·ªán ƒë·ªô ch√≠nh x√°c
class TemplateManager:
    def update_templates(self, employee_id: str, new_encoding: np.ndarray):
        # L·∫•y c√°c m·∫´u hi·ªán t·∫°i
        templates = get_employee_templates(employee_id)
        
        # ƒê√°nh gi√° ch·∫•t l∆∞·ª£ng
        if quality_score > MIN_QUALITY_FOR_LEARNING:
            # Th√™m m·∫´u m·ªõi
            add_template(employee_id, new_encoding, quality_score)
            
            # Duy tr√¨ gi·ªõi h·∫°n m·∫´u (c·ª≠a s·ªï tr∆∞·ª£t)
            if len(templates) > MAX_TEMPLATES_PER_EMPLOYEE:
                remove_oldest_template(employee_id)
```

> **Gi·∫£i th√≠ch thu·∫≠t ng·ªØ:**
> - **Template**: M·∫´u - d·ªØ li·ªáu ƒë·∫∑c tr∆∞ng khu√¥n m·∫∑t ƒë∆∞·ª£c l∆∞u tr·ªØ ƒë·ªÉ so s√°nh
> - **Rolling Window**: C·ª≠a s·ªï tr∆∞·ª£t - gi·ªØ s·ªë l∆∞·ª£ng m·∫´u c·ªë ƒë·ªãnh, lo·∫°i b·ªè m·∫´u c≈© khi th√™m m·∫´u m·ªõi
> - **Quality Score**: ƒêi·ªÉm ch·∫•t l∆∞·ª£ng - ƒë√°nh gi√° ƒë·ªô r√µ n√©t v√† ph√π h·ª£p c·ªßa ·∫£nh khu√¥n m·∫∑t
> - **Learning**: H·ªçc - qu√° tr√¨nh c·∫≠p nh·∫≠t v√† c·∫£i thi·ªán d·ªØ li·ªáu nh·∫≠n di·ªán

#### 3. **Thu·∫≠t To√°n Kh√°m Ph√° Thi·∫øt B·ªã (Device Discovery)**
```python
# Kh√°m ph√° d·ªãch v·ª• mDNS
def discover_server():
    # Ph√°t s√≥ng truy v·∫•n mDNS
    service_name = "_attendance._tcp.local."
    
    # L·∫Øng nghe ph·∫£n h·ªìi
    servers = mdns_query(service_name)
    
    # Tr·∫£ v·ªÅ th√¥ng tin m√°y ch·ªß
    return {
        "host": server.address,        # ƒê·ªãa ch·ªâ IP m√°y ch·ªß
        "port": server.port,           # C·ªïng d·ªãch v·ª•
        "service_type": server.type    # Lo·∫°i d·ªãch v·ª•
    }
```

> **Gi·∫£i th√≠ch thu·∫≠t ng·ªØ:**
> - **Broadcast**: Ph√°t s√≥ng - g·ª≠i th√¥ng tin ƒë·∫øn t·∫•t c·∫£ thi·∫øt b·ªã trong m·∫°ng
> - **Query**: Truy v·∫•n - y√™u c·∫ßu t√¨m ki·∫øm th√¥ng tin
> - **Host**: M√°y ch·ªß - thi·∫øt b·ªã cung c·∫•p d·ªãch v·ª•
> - **Port**: C·ªïng - s·ªë ƒë·ªãnh danh ƒë·ªÉ truy c·∫≠p d·ªãch v·ª• c·ª• th·ªÉ tr√™n m√°y ch·ªß

#### 4. **ƒêi·ªÅu Ph·ªëi ƒêa Thi·∫øt B·ªã (Multi-Device Coordination)**
```python
# Qu·∫£n l√Ω thi·∫øt b·ªã v·ªõi gi√°m s√°t heartbeat
class DeviceManager:
    async def process_attendance(self, device_id: str, image: bytes):
        # L·∫•y kh√≥a ri√™ng cho thi·∫øt b·ªã
        async with device_locks[device_id]:
            # X·ª≠ l√Ω nh·∫≠n di·ªán
            result = await recognition_service.recognize(image)
            
            # Ghi nh·∫≠t k√Ω ch·∫•m c√¥ng
            await log_attendance(device_id, result)
            
            # C·∫≠p nh·∫≠t tr·∫°ng th√°i thi·∫øt b·ªã
            await update_device_heartbeat(device_id)
```

> **Gi·∫£i th√≠ch thu·∫≠t ng·ªØ:**
> - **Lock**: Kh√≥a - c∆° ch·∫ø ƒë·∫£m b·∫£o ch·ªâ m·ªôt t√°c v·ª• ƒë∆∞·ª£c th·ª±c hi·ªán t·∫°i m·ªôt th·ªùi ƒëi·ªÉm
> - **Async**: B·∫•t ƒë·ªìng b·ªô - th·ª±c hi·ªán nhi·ªÅu t√°c v·ª• c√πng l√∫c m√† kh√¥ng ch·ªù ƒë·ª£i
> - **Heartbeat**: Nh·ªãp tim - t√≠n hi·ªáu ƒë·ªãnh k·ª≥ x√°c nh·∫≠n thi·∫øt b·ªã v·∫´n ho·∫°t ƒë·ªông
> - **Device Lock**: Kh√≥a thi·∫øt b·ªã - ƒë·∫£m b·∫£o m·ªói thi·∫øt b·ªã ch·ªâ x·ª≠ l√Ω m·ªôt y√™u c·∫ßu t·∫°i m·ªôt th·ªùi ƒëi·ªÉm

### C√°ch H·ªá Th·ªëng X·ª≠ L√Ω D·ªØ Li·ªáu

#### 1. **Quy Tr√¨nh X·ª≠ L√Ω H√¨nh ·∫¢nh (Image Processing Pipeline)**
```python
# Quy tr√¨nh x·ª≠ l√Ω h√¨nh ·∫£nh ch·∫•m c√¥ng
def process_attendance_image(image_bytes: bytes):
    # 1. X√°c th·ª±c & chuy·ªÉn ƒë·ªïi h√¨nh ·∫£nh
    image = cv2.imdecode(np.frombuffer(image_bytes, np.uint8), cv2.IMREAD_COLOR)
    
    # 2. Ph√°t hi·ªán khu√¥n m·∫∑t
    face_locations = face_recognition.face_locations(image)
    
    # 3. ƒê√°nh gi√° ch·∫•t l∆∞·ª£ng
    quality_metrics = {
        "brightness": assess_brightness(face_roi),    # ƒê·ªô s√°ng
        "sharpness": assess_sharpness(face_roi),      # ƒê·ªô n√©t
        "size": assess_face_size(face_roi)            # K√≠ch th∆∞·ªõc khu√¥n m·∫∑t
    }
    
    # 4. Tr√≠ch xu·∫•t m√£ h√≥a khu√¥n m·∫∑t
    face_encodings = face_recognition.face_encodings(image, face_locations)
    
    # 5. So s√°nh v·ªõi m·∫´u
    matches = compare_face_encodings(face_encodings, known_templates)
    
    return recognition_result
```

> **Gi·∫£i th√≠ch thu·∫≠t ng·ªØ:**
> - **Decode**: Gi·∫£i m√£ - chuy·ªÉn ƒë·ªïi d·ªØ li·ªáu t·ª´ format n√†y sang format kh√°c
> - **Buffer**: B·ªô ƒë·ªám - v√πng nh·ªõ t·∫°m th·ªùi l∆∞u tr·ªØ d·ªØ li·ªáu
> - **RGB**: Red, Green, Blue - kh√¥ng gian m√†u v·ªõi 3 k√™nh m√†u c∆° b·∫£n
> - **Metrics**: Ch·ªâ s·ªë - c√°c gi√° tr·ªã ƒëo l∆∞·ªùng ch·∫•t l∆∞·ª£ng
> - **Brightness**: ƒê·ªô s√°ng - m·ª©c ƒë·ªô √°nh s√°ng trong ·∫£nh
> - **Sharpness**: ƒê·ªô n√©t - m·ª©c ƒë·ªô r√µ r√†ng c·ªßa chi ti·∫øt trong ·∫£nh

#### 2. **X·ª≠ L√Ω Logic Ch·∫•m C√¥ng (Attendance Logic Processing)**
```python
# Nh√≥m v√† t√≠nh to√°n ch·∫•m c√¥ng
def process_attendance_display(raw_attendance_data):
    # Nh√≥m theo nh√¢n vi√™n + ng√†y
    grouped = {}
    for record in raw_attendance_data:
        key = f"{record.employee_id}_{record.date}"
        grouped[key] = grouped.get(key, []).append(record)
    
    # X·ª≠ l√Ω t·ª´ng nh√≥m
    for group in grouped.values():
        # S·∫Øp x·∫øp theo th·ªùi gian
        sorted_records = sorted(group, key=lambda x: x.timestamp)
        
        # T√¨m CHECK_IN ƒë·∫ßu ti√™n v√† CHECK_OUT cu·ªëi c√πng
        check_ins = [r for r in sorted_records if r.action_type == 'CHECK_IN']
        check_outs = [r for r in sorted_records if r.action_type == 'CHECK_OUT']
        
        first_in = check_ins[0] if check_ins else None
        last_out = check_outs[-1] if check_outs else None
        
        # T√≠nh gi·ªù l√†m vi·ªác
        if first_in and last_out:
            work_hours = calculate_hours(first_in.timestamp, last_out.timestamp)
```

> **Gi·∫£i th√≠ch thu·∫≠t ng·ªØ:**
> - **Grouping**: Nh√≥m - t·∫≠p h·ª£p c√°c b·∫£n ghi c√≥ c√πng ƒë·∫∑c ƒëi·ªÉm
> - **Sorting**: S·∫Øp x·∫øp - x·∫øp d·ªØ li·ªáu theo th·ª© t·ª± nh·∫•t ƒë·ªãnh
> - **Timestamp**: D·∫•u th·ªùi gian - th·ªùi ƒëi·ªÉm c·ª• th·ªÉ khi s·ª± ki·ªán x·∫£y ra
> - **Lambda**: H√†m ·∫©n danh - h√†m nh·ªè ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a tr·ª±c ti·∫øp t·∫°i ch·ªó s·ª≠ d·ª•ng

#### 3. **T√≠ch H·ª£p M√¥ H√¨nh AI (AI Model Integration)**
```python
# D·ªãch v·ª• AI tr·ª´u t∆∞·ª£ng
class RealAIService:
    def __init__(self):
        self.face_detector = MTCNN()      # M·∫°ng n∆°-ron ƒëa nhi·ªám
        self.face_recognizer = ArcFace()  # M√¥ h√¨nh ArcFace
        
    def extract_face_embedding(self, face_image: np.ndarray) -> np.ndarray:
        # Ti·ªÅn x·ª≠ l√Ω
        aligned_face = align_face(face_image)           # CƒÉn ch·ªânh khu√¥n m·∫∑t
        normalized_face = normalize_image(aligned_face)  # Chu·∫©n h√≥a ·∫£nh
        
        # Tr√≠ch xu·∫•t ƒë·∫∑c tr∆∞ng
        embedding = self.face_recognizer.get_embedding(normalized_face)
        
        return embedding
    
    def compare_embeddings(self, embedding1: np.ndarray, embedding2: np.ndarray) -> float:
        # T√≠nh ƒë·ªô t∆∞∆°ng t·ª± cosine
        similarity = cosine_similarity(embedding1, embedding2)
        return similarity
```

> **Gi·∫£i th√≠ch thu·∫≠t ng·ªØ:**
> - **MTCNN**: Multi-task CNN - m·∫°ng n∆°-ron t√≠ch ch·∫≠p ƒëa nhi·ªám cho ph√°t hi·ªán khu√¥n m·∫∑t
> - **ArcFace**: Thu·∫≠t to√°n nh·∫≠n di·ªán khu√¥n m·∫∑t ti√™n ti·∫øn s·ª≠ d·ª•ng h·ªçc s√¢u
> - **Alignment**: CƒÉn ch·ªânh - xoay v√† c·∫Øt khu√¥n m·∫∑t v·ªÅ v·ªã tr√≠ chu·∫©n
> - **Normalization**: Chu·∫©n h√≥a - ƒëi·ªÅu ch·ªânh gi√° tr·ªã pixel v·ªÅ kho·∫£ng chu·∫©n
> - **Embedding**: Vector nh√∫ng - bi·ªÉu di·ªÖn khu√¥n m·∫∑t d∆∞·ªõi d·∫°ng vector s·ªë nhi·ªÅu chi·ªÅu
> - **Cosine Similarity**: ƒê·ªô t∆∞∆°ng t·ª± cosine - ph∆∞∆°ng ph√°p ƒëo ƒë·ªô gi·ªëng nhau gi·ªØa hai vector

### C√°c C∆° Ch·∫ø T·ªëi ∆Øu

#### 1. **T·ªëi ∆Øu Hi·ªáu Su·∫•t (Performance Optimizations)**
- **X·ª≠ l√Ω B·∫•t ƒë·ªìng b·ªô**: FastAPI async/await cho x·ª≠ l√Ω y√™u c·∫ßu ƒë·ªìng th·ªùi
- **Kh√≥a Ri√™ng Thi·∫øt b·ªã**: NgƒÉn ch·∫∑n x·ª≠ l√Ω ƒë·ªìng th·ªùi tr√™n c√πng m·ªôt thi·∫øt b·ªã
- **Cache M·∫´u**: L∆∞u cache trong b·ªô nh·ªõ cho c√°c m·∫´u khu√¥n m·∫∑t
- **N√©n H√¨nh ·∫£nh**: T·ªëi ∆∞u k√≠ch th∆∞·ªõc file ·∫£nh ƒë∆∞·ª£c t·∫£i l√™n

> **Gi·∫£i th√≠ch thu·∫≠t ng·ªØ:**
> - **Concurrent**: ƒê·ªìng th·ªùi - nhi·ªÅu t√°c v·ª• ƒë∆∞·ª£c th·ª±c hi·ªán c√πng l√∫c
> - **Cache**: B·ªô nh·ªõ ƒë·ªám - l∆∞u tr·ªØ t·∫°m th·ªùi d·ªØ li·ªáu th∆∞·ªùng d√πng ƒë·ªÉ truy c·∫≠p nhanh
> - **Compression**: N√©n - gi·∫£m k√≠ch th∆∞·ªõc d·ªØ li·ªáu ƒë·ªÉ ti·∫øt ki·ªám b·ªô nh·ªõ v√† bƒÉng th√¥ng

#### 2. **C·∫£i Thi·ªán ƒê·ªô Ch√≠nh X√°c (Accuracy Improvements)**
- **H·ªá Th·ªëng M·∫´u H·ªçc Li√™n T·ª•c**: H·ªçc t·ª´ c√°c l·∫ßn nh·∫≠n di·ªán th√†nh c√¥ng
- **Nh·∫≠n Di·ªán ƒêa Ng∆∞·ª°ng**: C√°c m·ª©c ƒë·ªô tin c·∫≠y kh√°c nhau
- **ƒê√°nh Gi√° Ch·∫•t L∆∞·ª£ng**: L·ªçc b·ªè h√¨nh ·∫£nh ch·∫•t l∆∞·ª£ng th·∫•p
- **Ch·ªëng Gi·∫£ M·∫°o**: Ph√°t hi·ªán s·ª± s·ªëng c∆° b·∫£n (hi·ªán t·∫°i t·∫Øt ƒë·ªÉ test)

> **Gi·∫£i th√≠ch thu·∫≠t ng·ªØ:**
> - **Multi-threshold**: ƒêa ng∆∞·ª°ng - s·ª≠ d·ª•ng nhi·ªÅu m·ª©c chu·∫©n kh√°c nhau
> - **Anti-spoofing**: Ch·ªëng gi·∫£ m·∫°o - ph√°t hi·ªán vi·ªác s·ª≠ d·ª•ng ·∫£nh thay v√¨ khu√¥n m·∫∑t th·∫≠t
> - **Liveness Detection**: Ph√°t hi·ªán s·ª± s·ªëng - x√°c nh·∫≠n ƒë√¢y l√† ng∆∞·ªùi th·∫≠t ch·ª© kh√¥ng ph·∫£i ·∫£nh

#### 3. **C∆° Ch·∫ø M·ªü R·ªông (Scalability Mechanisms)**
- **M·ªü R·ªông Thi·∫øt B·ªã Ngang**: H·ªó tr·ª£ nhi·ªÅu thi·∫øt b·ªã kiosk
- **G·ªôp K·∫øt N·ªëi C∆° S·ªü D·ªØ Li·ªáu**: Qu·∫£n l√Ω t√†i nguy√™n c∆° s·ªü d·ªØ li·ªáu hi·ªáu qu·∫£
- **Kh√°m Ph√° D·ªãch V·ª•**: Th√™m thi·∫øt b·ªã m·ªõi kh√¥ng c·∫ßn c·∫•u h√¨nh
- **T√°c V·ª• D·ªçn D·∫πp**: T·ª± ƒë·ªông d·ªçn d·∫πp thi·∫øt b·ªã kh√¥ng ho·∫°t ƒë·ªông v√† d·ªØ li·ªáu c≈©

> **Gi·∫£i th√≠ch thu·∫≠t ng·ªØ:**
> - **Horizontal Scaling**: M·ªü r·ªông ngang - th√™m nhi·ªÅu thi·∫øt b·ªã/m√°y ch·ªß thay v√¨ n√¢ng c·∫•p ph·∫ßn c·ª©ng
> - **Connection Pooling**: G·ªôp k·∫øt n·ªëi - t√°i s·ª≠ d·ª•ng k·∫øt n·ªëi c∆° s·ªü d·ªØ li·ªáu ƒë·ªÉ ti·∫øt ki·ªám t√†i nguy√™n
> - **Zero-configuration**: Kh√¥ng c·∫ßn c·∫•u h√¨nh - t·ª± ƒë·ªông thi·∫øt l·∫≠p m√† kh√¥ng c·∫ßn can thi·ªáp th·ªß c√¥ng
> - **Cleanup**: D·ªçn d·∫πp - lo·∫°i b·ªè d·ªØ li·ªáu kh√¥ng c·∫ßn thi·∫øt ƒë·ªÉ gi·∫£i ph√≥ng t√†i nguy√™n

---

## üîÑ Lu·ªìng X·ª≠ L√Ω (Flow)

### 1. Device Registration & Discovery Flow

```mermaid
sequenceDiagram
    participant K as Kiosk Device
    participant DS as Discovery Service
    participant DM as Device Manager
    participant DB as Database
    
    K->>DS: mDNS query for "_attendance._tcp.local."
    DS->>K: Return server IP:PORT
    K->>DM: POST /devices/register {device_id, name}
    DM->>DB: Check if device exists
    DB->>DM: Device info or create new
    DM->>K: Return device config + token
    
    loop Heartbeat (every 30s)
        K->>DM: POST /devices/heartbeat {device_id, status}
        DM->>DB: Update last_seen timestamp
        DM->>K: ACK
    end
```

### 2. Attendance Processing Flow

```mermaid
sequenceDiagram
    participant U as User
    participant K as Kiosk App
    participant API as FastAPI Backend
    participant RS as Recognition Service
    participant TM as Template Manager
    participant DB as Database
    
    U->>K: Capture face image
    K->>K: Select attendance type (IN/OUT)
    K->>API: POST /attendance/check {image, device_id, attendance_type}
    
    API->>API: Get device lock (prevent concurrent processing)
    API->>RS: Process face recognition
    
    RS->>RS: Detect faces in image
    RS->>RS: Extract face encodings
    RS->>TM: Get employee templates from database
    TM->>DB: Query face_templates table
    DB->>TM: Return templates
    TM->>RS: Return template data
    
    RS->>RS: Compare encodings with templates
    RS->>RS: Calculate similarity scores
    
    alt Similarity > RECOGNITION_THRESHOLD
        RS->>API: Return {success: true, employee_id, confidence}
        API->>DB: Insert attendance record
        API->>TM: Update templates (if high confidence)
        TM->>DB: Add/update face template
        API->>K: Return success response
        K->>U: Show success message
    else Similarity < RECOGNITION_THRESHOLD
        RS->>API: Return {success: false, reason: "not_recognized"}
        API->>K: Return failure response
        K->>U: Show "Face not recognized" message
    end
```

### 3. Template Learning Flow

```mermaid
sequenceDiagram
    participant RS as Recognition Service
    participant TM as Template Manager
    participant DB as Database
    
    RS->>TM: update_templates(employee_id, face_encoding, quality_score)
    TM->>DB: Query existing templates for employee
    DB->>TM: Return current templates
    
    alt Quality Score > MIN_QUALITY_FOR_LEARNING
        TM->>DB: Insert new face template
        TM->>TM: Check template count
        
        alt Templates > MAX_PER_EMPLOYEE
            TM->>DB: Delete oldest template
        end
        
        TM->>RS: Return success
    else Quality Score too low
        TM->>RS: Return skip (no learning)
    end
```

### 4. Admin Dashboard Data Flow

```mermaid
sequenceDiagram
    participant A as Admin Dashboard
    participant API as FastAPI Backend
    participant DB as Database
    
    A->>API: GET /employees
    API->>DB: Query employees table
    DB->>API: Return employee list
    API->>A: Return formatted employee data
    
    A->>API: GET /attendance
    API->>DB: Query attendance table (ordered by timestamp)
    DB->>API: Return raw attendance records
    API->>A: Return attendance data
    
    A->>A: Group attendance by employee + date
    A->>A: Calculate CHECK_IN (first) and CHECK_OUT (last)
    A->>A: Calculate working hours
    A->>A: Display attendance table
    
    Note over A: Auto-refresh every 30 seconds
    loop Every 30 seconds
        A->>API: Refresh attendance data
    end
```

### 5. Error Handling Flow

```mermaid
sequenceDiagram
    participant K as Kiosk
    participant API as Backend
    participant DB as Database
    
    K->>API: Send request
    
    alt Database Connection Failed
        API->>K: Return {error: "database_unavailable"}
        K->>K: Show "System temporarily unavailable"
    else Invalid Image Format
        API->>K: Return {error: "invalid_image"}
        K->>K: Show "Please capture image again"
    else Face Not Detected
        API->>K: Return {error: "no_face_detected"}
        K->>K: Show "No face detected in image"
    else Multiple Faces Detected
        API->>K: Return {error: "multiple_faces"}
        K->>K: Show "Multiple faces detected"
    else Recognition Failed
        API->>K: Return {error: "recognition_failed"}
        K->>K: Show "Face not recognized"
    else Success
        API->>DB: Log attendance
        API->>K: Return {success: true, employee_info}
        K->>K: Show success message
    end
```

---

## üîå API & Giao Ti·∫øp

### C√°c Endpoint API Ch√≠nh

#### 1. **Device Management APIs**
```python
# Device registration & management
POST /api/v1/devices/register
Body: {
    "device_id": "KIOSK001",
    "device_name": "Main Entrance Kiosk",
    "ip_address": "192.168.1.100"
}
Response: {
    "device_id": "KIOSK001",
    "status": "active",
    "token": "jwt_token_here"
}

# Device heartbeat
POST /api/v1/devices/heartbeat
Body: {
    "device_id": "KIOSK001",
    "status": "online",
    "timestamp": "2025-08-25T10:00:00"
}

# Get device list
GET /api/v1/devices/
Response: [
    {
        "device_id": "KIOSK001",
        "device_name": "Main Entrance",
        "status": "online",
        "last_seen": "2025-08-25T10:00:00"
    }
]
```

#### 2. **Attendance Processing APIs**
```python
# Main attendance check endpoint
POST /api/v1/attendance/check
Headers: Content-Type: multipart/form-data
Body: {
    "image": <binary_image_file>,
    "device_id": "KIOSK001",
    "attendance_type": "IN"  # or "OUT"
}
Response: {
    "success": true,
    "message": "Ch·∫•m c√¥ng th√†nh c√¥ng!",
    "employee": {
        "employee_id": "EMP001",
        "name": "Nguy·ªÖn VƒÉn A",
        "department": "IT"
    },
    "attendance_id": 123,
    "timestamp": "2025-08-25T08:00:00",
    "confidence": 0.87
}

# Get all attendance records
GET /api/v1/attendance/
Response: [
    {
        "id": 1,
        "employee_id": "EMP001",
        "device_id": "KIOSK001",
        "timestamp": "2025-08-25T08:00:00",
        "action_type": "CHECK_IN",
        "confidence": 0.87
    }
]

# Get employee attendance history
GET /api/v1/attendance/employee/{employee_id}
Response: [/* attendance records for specific employee */]
```

#### 3. **Employee Management APIs**
```python
# Get all employees
GET /api/v1/employees/
Response: [
    {
        "employee_id": "EMP001",
        "name": "Nguy·ªÖn VƒÉn A",
        "department": "IT",
        "position": "Developer",
        "email": "nguyenvana@company.com"
    }
]

# Add new employee
POST /api/v1/employees/
Body: {
    "employee_id": "EMP002",
    "name": "Tr·∫ßn Th·ªã B",
    "department": "HR",
    "position": "HR Manager",
    "email": "tranthib@company.com"
}

# Upload employee photo with face templates
POST /api/v1/employees/with-photo
Body: multipart/form-data {
    "employee_data": {employee_json},
    "photo": <image_file>
}
```

#### 4. **Recognition & Template APIs**
```python
# Face recognition endpoint
POST /api/v1/recognition/face
Body: {
    "image": <base64_encoded_image>
}
Response: {
    "success": true,
    "employee_id": "EMP001",
    "confidence": 0.87,
    "face_location": [top, right, bottom, left]
}

# Template management
GET /api/templates/employee/{employee_id}
Response: {
    "employee_id": "EMP001",
    "templates": [
        {
            "id": 1,
            "created_at": "2025-08-25T08:00:00",
            "quality_score": 0.92,
            "usage_count": 15
        }
    ]
}
```

#### 5. **Service Discovery APIs**
```python
# mDNS service discovery
GET /api/v1/discovery/mdns
Response: {
    "service_name": "_attendance._tcp.local.",
    "host": "192.168.1.10",
    "port": 8000,
    "server_info": {
        "version": "2.0.0",
        "capabilities": ["face_recognition", "multi_device"]
    }
}
```

### Input/Output D·ªØ Li·ªáu

#### **Input Data Formats**
```python
# Image data
image_input = {
    "format": ["JPEG", "PNG", "BMP"],
    "max_size": "10MB",
    "recommended_size": "1920x1080",
    "color_space": "RGB"
}

# Employee data
employee_input = {
    "employee_id": "string (required, unique)",
    "name": "string (required)",
    "department": "string (optional)",
    "position": "string (optional)",
    "email": "string (optional, valid email)"
}

# Device data
device_input = {
    "device_id": "string (required, unique)",
    "device_name": "string (required)",
    "ip_address": "string (optional, auto-detected)"
}
```

#### **Output Data Formats**
```python
# Standard API response
api_response = {
    "success": "boolean",
    "data": "object|array (if success)",
    "error": "string (if failed)",
    "message": "string (user-friendly message)",
    "timestamp": "ISO 8601 datetime"
}

# Recognition response
recognition_response = {
    "success": "boolean",
    "employee_id": "string",
    "confidence": "float (0.0-1.0)",
    "face_detected": "boolean",
    "processing_time": "float (seconds)"
}
```

### C√°ch C√°c Module Giao Ti·∫øp

#### 1. **Frontend ‚Üî Backend Communication**
```python
# HTTP/REST API calls
Frontend (React/Flutter) ‚Üí Backend (FastAPI)
- Headers: Authorization: Bearer <jwt_token>
- Content-Type: application/json | multipart/form-data
- Error handling: Standard HTTP status codes
```

#### 2. **Internal Service Communication**
```python
# Service-to-service calls within backend
class RecognitionService:
    def __init__(self):
        self.template_manager = TemplateManager()
        self.ai_service = AIService()
    
    async def recognize_face(self, image):
        # Call template manager
        templates = await self.template_manager.get_templates(employee_id)
        
        # Call AI service
        result = await self.ai_service.process_image(image, templates)
        
        return result
```

#### 3. **Database Communication**
```python
# SQLAlchemy ORM patterns
async def get_employee_attendance(db: Session, employee_id: str):
    return db.query(Attendance)\
             .filter(Attendance.employee_id == employee_id)\
             .order_by(Attendance.timestamp.desc())\
             .all()
```

#### 4. **Device Discovery Communication**
```python
# mDNS service discovery
class DiscoveryService:
    @staticmethod
    def register_service():
        # Register service on network
        mdns.register_service(
            name="Face Attendance Server",
            service_type="_attendance._tcp.local.",
            port=8000
        )
    
    @staticmethod
    def discover_servers():
        # Discover available servers
        services = mdns.discover_services("_attendance._tcp.local.")
        return services
```

---

## ‚úÖ ∆Øu ƒêi·ªÉm & H·∫°n Ch·∫ø

### ∆Øu ƒêi·ªÉm Trong Thi·∫øt K·∫ø & C√¥ng Ngh·ªá

#### **1. Ki·∫øn Tr√∫c T·ªët**
‚úÖ **Modular Design**: T√°ch bi·ªát r√µ r√†ng gi·ªØa API, Service, v√† Data layers
‚úÖ **Async Architecture**: FastAPI async/await cho high performance
‚úÖ **Service Discovery**: Zero-config device connection qua mDNS
‚úÖ **Multi-device Support**: Horizontal scaling v·ªõi nhi·ªÅu kiosk devices

#### **2. AI/ML Integration**
‚úÖ **Rolling Template System**: Continuous learning v√† improvement
‚úÖ **Multi-threshold Recognition**: Flexible confidence levels
‚úÖ **Quality Assessment**: Filter low-quality images
‚úÖ **Multiple AI Models**: Support cho MTCNN, ArcFace, YOLOv11

#### **3. Security & Reliability**
‚úÖ **JWT Authentication**: Secure device authentication
‚úÖ **Input Validation**: Pydantic schemas cho data validation
‚úÖ **Error Handling**: Comprehensive error handling v√† logging
‚úÖ **Database Migrations**: Alembic cho version control c·ªßa database schema

#### **4. Developer Experience**
‚úÖ **Auto-generated Docs**: FastAPI Swagger/OpenAPI documentation
‚úÖ **Type Hints**: Full Python type annotations
‚úÖ **Container Support**: Docker deployment ready
‚úÖ **Development Tools**: Hot reload, debugging support

#### **5. Scalability Features**
‚úÖ **Database Connection Pooling**: Efficient resource management
‚úÖ **Device-specific Locks**: Prevent race conditions
‚úÖ **Cleanup Tasks**: Automatic cleanup c·ªßa inactive devices
‚úÖ **Horizontal Device Scaling**: Easy addition c·ªßa new kiosks

### C√°c R·ªßi Ro & H·∫°n Ch·∫ø Ti·ªÅm ·∫®n

#### **1. Performance Limitations**
‚ö†Ô∏è **AI Processing Overhead**: Face recognition c√≥ th·ªÉ ch·∫≠m v·ªõi low-end hardware
‚ö†Ô∏è **Memory Usage**: Face templates v√† AI models consume significant memory
‚ö†Ô∏è **Database Bottleneck**: Single PostgreSQL instance cho t·∫•t c·∫£ devices
‚ö†Ô∏è **Image Processing**: Large image files c√≥ th·ªÉ impact response time

#### **2. Security Concerns**
‚ö†Ô∏è **Face Spoofing**: Anti-spoofing hi·ªán t·∫°i disabled cho testing
‚ö†Ô∏è **Network Security**: mDNS discovery c√≥ th·ªÉ expose service information
‚ö†Ô∏è **Data Privacy**: Face templates stored trong database c·∫ßn encryption
‚ö†Ô∏è **Device Authentication**: JWT tokens c·∫ßn proper rotation policy

#### **3. Reliability Issues**
‚ö†Ô∏è **Single Point of Failure**: Backend server downtime affects t·∫•t c·∫£ devices
‚ö†Ô∏è **Network Dependency**: Devices require stable network connection
‚ö†Ô∏è **Template Quality**: Poor quality images c√≥ th·ªÉ degrade recognition accuracy
‚ö†Ô∏è **Database Corruption**: No backup/recovery mechanism ƒë∆∞·ª£c implement

#### **4. Scalability Constraints**
‚ö†Ô∏è **Vertical Scaling Only**: AI processing bound by single server resources
‚ö†Ô∏è **Template Storage**: Face templates grow linearly v·ªõi s·ªë employees
‚ö†Ô∏è **Concurrent Processing**: Limited by device locks v√† database connections
‚ö†Ô∏è **Network Bandwidth**: Image uploads c√≥ th·ªÉ saturate local network

#### **5. Operational Challenges**
‚ö†Ô∏è **Monitoring Gaps**: Limited monitoring c·ªßa AI model performance
‚ö†Ô∏è **Configuration Management**: Multi-device configuration c√≥ th·ªÉ complex
‚ö†Ô∏è **Error Recovery**: Limited automatic recovery mechanisms
‚ö†Ô∏è **Data Migration**: No easy migration path for existing attendance data

---

## üöÄ ƒê·ªÅ Xu·∫•t C·∫£i Ti·∫øn

### 1. Performance Optimization

#### **AI Processing Improvements**
```python
# Implement GPU acceleration
pip install onnxruntime-gpu torch-gpu

# Add model caching
class ModelCache:
    def __init__(self):
        self.face_detector = self._load_detector()
        self.face_recognizer = self._load_recognizer()
    
    @lru_cache(maxsize=1000)
    def get_face_embedding(self, image_hash: str) -> np.ndarray:
        # Cache face embeddings ƒë·ªÉ avoid recomputation
        pass

# Implement async image processing
async def process_images_batch(images: List[bytes]) -> List[Dict]:
    tasks = [process_single_image(img) for img in images]
    results = await asyncio.gather(*tasks)
    return results
```

#### **Database Optimization**
```python
# Add database indexing
CREATE INDEX idx_attendance_employee_date ON attendance(employee_id, DATE(timestamp));
CREATE INDEX idx_face_templates_employee ON face_templates(employee_id);
CREATE INDEX idx_devices_status ON devices(status, last_seen);

# Implement connection pooling
from sqlalchemy.pool import QueuePool

engine = create_async_engine(
    DATABASE_URL,
    poolclass=QueuePool,
    pool_size=20,
    max_overflow=30,
    pool_pre_ping=True
)

# Add read replicas
class DatabaseRouter:
    def route_read_queries(self) -> Session:
        return get_read_replica_session()
    
    def route_write_queries(self) -> Session:
        return get_master_session()
```

### 2. Security Enhancements

#### **Advanced Anti-Spoofing**
```python
class AntiSpoofingService:
    def __init__(self):
        self.liveness_detector = LivenessDetector()
        self.depth_estimator = DepthEstimator()
    
    async def detect_liveness(self, image: np.ndarray) -> Dict:
        # Implement multiple anti-spoofing checks
        checks = {
            "blink_detection": await self.detect_blink(image),
            "depth_analysis": await self.analyze_depth(image),
            "texture_analysis": await self.analyze_texture(image),
            "motion_detection": await self.detect_motion(image)
        }
        
        confidence = self.calculate_liveness_score(checks)
        return {"is_live": confidence > 0.8, "confidence": confidence}
```

#### **Enhanced Authentication**
```python
# Implement device certificate authentication
class DeviceAuthService:
    def generate_device_certificate(self, device_id: str) -> Dict:
        # Generate X.509 certificate cho device
        private_key = rsa.generate_private_key(65537, 2048)
        certificate = self.create_certificate(device_id, private_key)
        return {"certificate": certificate, "private_key": private_key}
    
    def verify_device_certificate(self, cert: str) -> bool:
        # Verify device certificate
        return self.validate_certificate(cert)

# Add rate limiting
from slowapi import Limiter
limiter = Limiter(key_func=get_remote_address)

@app.post("/attendance/check")
@limiter.limit("10/minute")  # Limit attendance attempts
async def check_attendance(request: Request, ...):
    pass
```

#### **Data Encryption**
```python
# Encrypt face templates at rest
class TemplateEncryption:
    def __init__(self, encryption_key: bytes):
        self.cipher_suite = Fernet(encryption_key)
    
    def encrypt_template(self, template_data: np.ndarray) -> bytes:
        serialized = pickle.dumps(template_data)
        encrypted = self.cipher_suite.encrypt(serialized)
        return encrypted
    
    def decrypt_template(self, encrypted_data: bytes) -> np.ndarray:
        decrypted = self.cipher_suite.decrypt(encrypted_data)
        template_data = pickle.loads(decrypted)
        return template_data
```

### 3. Reliability & High Availability

#### **Implement Microservices Architecture**
```python
# Split into separate services
services = {
    "recognition_service": "AI processing service",
    "device_service": "Device management service", 
    "attendance_service": "Attendance logging service",
    "template_service": "Template management service"
}

# Add service mesh
from consul import Consul

class ServiceRegistry:
    def __init__(self):
        self.consul = Consul()
    
    def register_service(self, name: str, address: str, port: int):
        self.consul.agent.service.register(
            name=name,
            service_id=f"{name}-{address}-{port}",
            address=address,
            port=port,
            check=Check.http(f"http://{address}:{port}/health", 10)
        )
```

#### **Add Circuit Breaker Pattern**
```python
class CircuitBreaker:
    def __init__(self, failure_threshold: int = 5, timeout: int = 60):
        self.failure_threshold = failure_threshold
        self.timeout = timeout
        self.failure_count = 0
        self.last_failure_time = None
        self.state = "CLOSED"  # CLOSED, OPEN, HALF_OPEN
    
    async def call(self, func, *args, **kwargs):
        if self.state == "OPEN":
            if time.time() - self.last_failure_time > self.timeout:
                self.state = "HALF_OPEN"
            else:
                raise Exception("Circuit breaker is OPEN")
        
        try:
            result = await func(*args, **kwargs)
            self.reset()
            return result
        except Exception as e:
            self.record_failure()
            raise e
```

#### **Database Backup & Recovery**
```python
# Automated backup system
class BackupService:
    def __init__(self):
        self.storage_client = boto3.client('s3')
    
    async def backup_database(self):
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        backup_file = f"attendance_backup_{timestamp}.sql"
        
        # Create database dump
        subprocess.run([
            "pg_dump", 
            DATABASE_URL, 
            "-f", backup_file
        ])
        
        # Upload to cloud storage
        await self.upload_to_s3(backup_file)
    
    async def schedule_backups(self):
        # Schedule daily backups
        scheduler = AsyncIOScheduler()
        scheduler.add_job(
            self.backup_database,
            'cron',
            hour=2, minute=0  # Daily at 2 AM
        )
        scheduler.start()
```

### 4. Monitoring & Observability

#### **Application Monitoring**
```python
# Add comprehensive logging
import structlog
from opentelemetry import trace

logger = structlog.get_logger()
tracer = trace.get_tracer(__name__)

@tracer.start_as_current_span("face_recognition")
async def recognize_face(image: bytes, device_id: str):
    with tracer.start_as_current_span("image_preprocessing") as span:
        processed_image = preprocess_image(image)
        span.set_attribute("image_size", len(image))
    
    with tracer.start_as_current_span("ai_inference") as span:
        result = await ai_service.recognize(processed_image)
        span.set_attribute("confidence", result.confidence)
    
    logger.info("face_recognition_completed", 
                device_id=device_id, 
                confidence=result.confidence,
                processing_time=span.duration)
    
    return result

# Add metrics collection
from prometheus_client import Counter, Histogram, Gauge

# Metrics
attendance_counter = Counter('attendance_total', 'Total attendance checks', ['device_id', 'result'])
recognition_time = Histogram('recognition_duration_seconds', 'Recognition processing time')
active_devices = Gauge('active_devices_total', 'Number of active devices')

@recognition_time.time()
async def process_attendance(image, device_id):
    result = await recognize_face(image, device_id)
    attendance_counter.labels(device_id=device_id, result=result.status).inc()
    return result
```

#### **Health Monitoring Dashboard**
```python
# Health check endpoints
@app.get("/health/detailed")
async def detailed_health_check():
    checks = {
        "database": await check_database_health(),
        "ai_service": await check_ai_service_health(),
        "storage": await check_storage_health(),
        "external_apis": await check_external_apis_health()
    }
    
    overall_status = "healthy" if all(checks.values()) else "unhealthy"
    
    return {
        "status": overall_status,
        "checks": checks,
        "timestamp": datetime.utcnow(),
        "version": app.version
    }

# Device monitoring
class DeviceMonitor:
    async def monitor_device_health(self):
        for device in await get_all_devices():
            last_seen = device.last_seen
            if datetime.utcnow() - last_seen > timedelta(minutes=5):
                await self.alert_device_offline(device.device_id)
            
            # Check device performance metrics
            metrics = await self.get_device_metrics(device.device_id)
            if metrics.error_rate > 0.1:  # 10% error rate
                await self.alert_high_error_rate(device.device_id, metrics.error_rate)
```

### 5. Advanced Features

#### **Real-time Notifications**
```python
# WebSocket support for real-time updates
from fastapi import WebSocket

class NotificationService:
    def __init__(self):
        self.active_connections: List[WebSocket] = []
    
    async def connect(self, websocket: WebSocket):
        await websocket.accept()
        self.active_connections.append(websocket)
    
    async def broadcast_attendance_update(self, attendance_data: Dict):
        message = {
            "type": "attendance_update",
            "data": attendance_data,
            "timestamp": datetime.utcnow().isoformat()
        }
        
        for connection in self.active_connections:
            try:
                await connection.send_json(message)
            except:
                self.active_connections.remove(connection)

@app.websocket("/ws/notifications")
async def websocket_endpoint(websocket: WebSocket):
    await notification_service.connect(websocket)
    try:
        while True:
            await websocket.receive_text()
    except:
        notification_service.active_connections.remove(websocket)
```

#### **Advanced Analytics**
```python
# Analytics service
class AttendanceAnalytics:
    def generate_attendance_report(self, start_date: date, end_date: date) -> Dict:
        # Calculate attendance statistics
        stats = {
            "total_employees": self.get_total_employees(),
            "average_attendance_rate": self.calculate_attendance_rate(start_date, end_date),
            "late_arrivals": self.count_late_arrivals(start_date, end_date),
            "early_departures": self.count_early_departures(start_date, end_date),
            "overtime_hours": self.calculate_overtime(start_date, end_date),
            "department_breakdown": self.get_department_breakdown(start_date, end_date)
        }
        return stats
    
    def predict_attendance_patterns(self) -> Dict:
        # ML-based attendance prediction
        model = self.load_prediction_model()
        predictions = model.predict_next_week_attendance()
        return {
            "predictions": predictions,
            "confidence": model.confidence_score,
            "factors": model.important_features
        }
```

#### **Mobile Integration**
```python
# Mobile API endpoints
@app.post("/mobile/attendance/check")
async def mobile_attendance_check(
    image: UploadFile = File(...),
    location: Optional[str] = Form(None),
    user_id: str = Form(...),
    request: Request = None
):
    # Verify location if provided
    if location:
        is_valid_location = await verify_office_location(location)
        if not is_valid_location:
            raise HTTPException(400, "Invalid location for attendance")
    
    # Process attendance similar to kiosk
    result = await process_mobile_attendance(image, user_id, location)
    return result

# Push notifications
class PushNotificationService:
    def __init__(self):
        self.fcm = FCMNotification(api_key=FCM_API_KEY)
    
    async def send_attendance_reminder(self, employee_id: str):
        device_token = await get_employee_device_token(employee_id)
        message = {
            "title": "Attendance Reminder",
            "body": "Don't forget to check in!",
            "data": {"type": "attendance_reminder"}
        }
        
        await self.fcm.notify_single_device(
            registration_id=device_token,
            message_title=message["title"],
            message_body=message["body"],
            data_message=message["data"]
        )
```

---

## üìä K·∫øt Lu·∫≠n

Face Attendance System l√† m·ªôt d·ª± √°n **well-architected** v·ªõi:

### **ƒêi·ªÉm M·∫°nh Ch√≠nh**:
1. **Modern Tech Stack**: FastAPI, SQLAlchemy, AI/ML integration
2. **Scalable Architecture**: Multi-device support v·ªõi service discovery
3. **Smart Recognition**: Rolling template system v·ªõi continuous learning
4. **Developer-Friendly**: Type hints, auto-generated docs, container support

### **Opportunities for Growth**:
1. **Security Hardening**: Anti-spoofing, encryption, advanced authentication
2. **Performance Optimization**: GPU acceleration, caching, load balancing  
3. **Operational Excellence**: Monitoring, alerting, automated backup
4. **Advanced Features**: Real-time notifications, analytics, mobile integration

### **Technical Debt**:
- Anti-spoofing currently disabled
- Single point of failure architecture
- Limited error recovery mechanisms
- Manual device configuration

### **Recommended Next Steps**:
1. **Phase 1**: Implement security enhancements (anti-spoofing, encryption)
2. **Phase 2**: Add monitoring v√† reliability improvements
3. **Phase 3**: Performance optimization v√† caching
4. **Phase 4**: Advanced features (analytics, mobile app, real-time notifications)

D·ª± √°n c√≥ foundation t·ªët v√† ready cho production v·ªõi m·ªôt s·ªë security improvements c·∫ßn thi·∫øt.
